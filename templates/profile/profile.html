{% extends "base.html" %}

{% block title %}个人资料 - 科创竞赛管理平台{% endblock %}

{% block content %}
<div class="page-header">
    <h1>个人资料</h1>
</div>

<div class="card">
    <div class="card-header">
        <h2>基本信息</h2>
    </div>
    
    <form method="POST" action="{{ url_for('profile.profile') }}" class="auth-form">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            <label class="form-label">学工号/用户名</label>
            <input type="text" class="form-control" value="{{ current_user.work_id or current_user.username }}" disabled>
            <small class="form-text">学工号/用户名不可修改</small>
        </div>

        <div class="form-group">
            {{ form.real_name.label(class="form-label") }}
            {{ form.real_name(class="form-control", required=True, aria_required="true") }}
            {% if form.real_name.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.real_name.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.email.label(class="form-label") }}
            <!-- 隐藏的假邮箱字段，用于欺骗浏览器自动填充 -->
            <input type="email" name="fake_email" id="fake_email" autocomplete="email" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" tabindex="-1" aria-hidden="true">
            <!-- 真实的邮箱输入字段 -->
            <input type="text" name="email" id="email" class="form-control" autocomplete="off" placeholder="请输入邮箱" value="" data-work-id="{{ current_user.work_id or '' }}" readonly onfocus="this.removeAttribute('readonly');">
            {% if form.email.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.email.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <script>
            // 从根本上防止自动填充：使用readonly属性，只在用户点击时移除
            (function() {
                document.addEventListener('DOMContentLoaded', function() {
                    var emailInput = document.getElementById('email');
                    var fakeEmailInput = document.getElementById('fake_email');
                    
                    if (emailInput) {
                        // 确保字段始终为空
                        emailInput.value = '';
                        
                        // 表单提交前，如果值是学工号，清空
                        var form = emailInput.closest('form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                var workId = emailInput.getAttribute('data-work-id');
                                if (workId && emailInput.value === workId) {
                                    emailInput.value = '';
                                }
                            });
                        }
                    }
                    
                    // 让假字段接收自动填充
                    if (fakeEmailInput) {
                        fakeEmailInput.addEventListener('input', function() {
                            // 如果假字段被填充，清空它
                            this.value = '';
                        });
                    }
                });
            })();
        </script>

        {% if current_user.work_id and current_user.role in ['student', 'college_admin'] %}
        <div class="form-group">
            <label class="form-label">学院</label>
            <input type="text" class="form-control" value="{{ current_user.college or '未设置' }}" disabled>
        </div>
        {% elif current_user.role in ['school_admin', 'judge'] %}
        <div class="form-group">
            {{ form.unit.label(class="form-label") }}
            {{ form.unit(class="form-control", placeholder="请输入单位") }}
            {% if form.unit.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.unit.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="form-group">
            {{ form.contact_info.label(class="form-label") }}
            {{ form.contact_info(class="form-control", placeholder="请输入联系方式（如手机号）") }}
            {% if form.contact_info.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.contact_info.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label class="form-label">角色</label>
            <input type="text" class="form-control" value="{% if current_user.role == 'student' %}学生{% elif current_user.role == 'college_admin' %}学院管理员{% elif current_user.role == 'school_admin' %}校级管理员{% elif current_user.role == 'judge' %}校外专家{% endif %}" disabled>
        </div>

        <div class="card-header" style="margin-top: var(--spacing-xl); padding-top: var(--spacing-lg);">
            <h2>修改密码</h2>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--spacing-sm);">如需修改密码，请填写以下信息（留空则不修改）</p>
        </div>

        <div class="form-group">
            {{ form.old_password.label(class="form-label") }}
            {{ form.old_password(class="form-control", autocomplete="current-password") }}
            {% if form.old_password.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.old_password.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.new_password.label(class="form-label") }}
            {{ form.new_password(class="form-control", autocomplete="new-password") }}
            {% if form.new_password.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.new_password.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.confirm_password.label(class="form-label") }}
            {{ form.confirm_password(class="form-control", autocomplete="new-password") }}
            {% if form.confirm_password.errors %}
                <div class="form-error" role="alert">
                    {% for error in form.confirm_password.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary btn-block">保存修改</button>
        </div>
    </form>
</div>
{% endblock %}

